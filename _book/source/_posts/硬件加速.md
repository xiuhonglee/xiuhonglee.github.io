---
title: 硬件加速
date: 2016-12-08 11:06:44
tags: 前端性能
---

[文章来源](https://www.sitepoint.com/introduction-to-hardware-acceleration-css-animations/)

#### 1. 本节内容
```
1. 硬件加速如何工作
2. 如何合理使用硬件加速
```


#### 2. 为什么使用？

> 示例：一组在z轴上堆叠起来的小球(看起来是一个，这里只是为了体现性能差异而堆叠了很多小球)

##### 2.1通过调整小球的left和top来实现动画效果。


```css
.ball-running {
  animation: run-around 4s infinite;
}

@keyframes run-around {
  0%: {
    top: 0;
    left: 0;
  }

  25% {
    top: 0;
    left: 200px;
  }

  50% {
    top: 200px;
    left: 200px;
  }

  75% {
    top: 200px;
    left: 0;
  }
}

```


![动画效果](https://d17oy1vhnax1f7.cloudfront.net/items/333s0o0m0i1T3S3E1c3m/Screen%20Recording%202016-12-08%20at%2011.18%20%E4%B8%8A%E5%8D%88.gif?v=c8a89a67)

[☞ CodePe完整示例](http://codepen.io/SitePoint/pen/WQVxQQ/)


##### 2.2通过translate来实现动画

```css
.ball-running {
  animation: run-around 4s infinite;
}

@keyframes run-around {
  0%: {
    transform: translate(0, 0);
  }

  25% {
    transform: translate(200px, 0);
  }

  50% {
    transform: translate(200px, 200px);
  }

  75% {
    transform: translate(0, 200px);
  }
}

```


![动画效果](https://d17oy1vhnax1f7.cloudfront.net/items/2z0120161D291Q2u0B2G/Screen%20Recording%202016-12-08%20at%2011.23%20%E4%B8%8A%E5%8D%88.gif?v=cc7bb3d1)

[☞ CodePe完整示例](http://codepen.io/SitePoint/pen/OyKXyK/)



#### 3.性能对比

* 使用left-top来实现动画
![](https://d17oy1vhnax1f7.cloudfront.net/items/153v083Z353K1u392q0b/Image%202016-12-08%20at%2012.05.53%20%E4%B8%8B%E5%8D%88.png?v=28340892)

* 使用translate来实现动画
![](https://d17oy1vhnax1f7.cloudfront.net/items/1w1R2D1Y341W022D411v/Image%202016-12-08%20at%2012.08.38%20%E4%B8%8B%E5%8D%88.png?v=58cf1fb1)

> 使用left-top的示例，每一步的动画(animation step)都会导致页面重绘(green bar)。渲染速率FPS低于60，直观上感到动画不流畅。使用translate，不会导致页面重绘。

* 开启下面的选项，可以观察到动画过程中页面那哪些部分尽心过来重绘
![](https://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2015/11/1448804173hardware-acc-03.jpg)


**为什么使用transform实现动画不需要重绘？**
* 因为CSS transforms直接使用GPU内存来渲染（硬件），也就是触发了硬件加速，避免了重绘操作(软件)；线面详解!


#### 4. 硬件加速如何工作

> 浏览器加载完页面资源(HTML/CSS/JS)后，开始进行DOM树构建。最终浏览器将DOM树和CSS合成渲染树，渲染树上的每一个渲染对象都会被分配到一个图层上去渲染。各图层会被作为GPU的一个组成部分被加载进去。**注意：图层顺序的改变不会触发页面重绘！**

* 上例，CSS transform创建了一个新的图层，该图层上的元素可以在不导致重绘的情况下进行位移变换。
![](https://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2015/11/1448804178hardware-acc-04.jpg)

使用transform属性实现动画的小球，出在橘黄色边框内，单独成为一个图层。

##### 4.1 什么情况下浏览器会新建图层

1. 对于3D或CSS transforms  
2. video或canvas元素  
3. 当使用CSS filters属性时  
4. 重叠元素，分层（最常见的z-index分层）  

> 示例中使用的是2D位移变换(transform)而非3D转换。区别在哪里？两者新建图层的时机不同。

![](https://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2015/11/1448781619hardware-acc-05.png)

3D transfrom会在动画之前创建新的图层。而2D transform是在动画过程中(fly)进行图层创建，动画结束后，浏览器移除图层，所以2D transform是在动画开始和结束动态创建、移除图层的，这样会导致在动画开始、结束时刻导致页面重绘。

##### 4.2 对GPU支持友好属性

* transform 
* opacity
* filter

> 为确保动画顺滑(high-quality animation)，尽量使用GUP-friendly属性


##### 4.3 强制元素在GPU中渲染

> 某种情况下，为了避免新建图层导致的重绘，我们希望在动画开始前就使用GPU进行渲染。可以通过下面的'transform hack'方法实现。

```css
.example1 {
  transform: translateZ(0);
}

.example2 {
  transform: rotateZ(360deg);
}
```


**使用场景**

* 当渲染一个元素由于另一个元素的影响消耗性能严重时，使用上述方法可避免；如上例中使用top-left实现动画的场景，在底部添加filter背景图，这样导致动画不流畅。
[1. 未使用transform hack的动画](http://codepen.io/SitePoint/pen/LpwZbJ/)
[2. 使用transform hack的动画](http://codepen.io/SitePoint/pen/zvgBNp/)

Why? 添加了`transfomr: translateZ(0)的背景(blurred paint-expensive)被移到另一个图层中去了，减少了渲染小球所耗费的性能。


#### 5. 慎用硬件加速

##### 5.1 内存
> 新建太多的图层会增减内存消耗；特别是在移动端使用硬件加速，使用不当会导致浏览器因内存溢出导致crash；

##### 5.2 字体渲染
> GPU和CPU的渲染机制差异，会导致字体的展示有差异。如：对字体使用transform实现动画是，字体会变糊 [具体参考](http://keithclark.co.uk/articles/gpu-text-rendering-in-webkit/)


#### 6. 总结

* 利用GPU可以提高动画质量
* GPU渲染动画帧率在任何设备上都应该是60帧/秒
* 使用GPU-Friendly CSS属性
* 如何通过'transform hack'触发硬件加速
